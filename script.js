const movies = [
  {
  title: "Resident Playbook",
  genre: "Drama, Medical",
  rating: "★ 8.9",
  year: "2025",
  duration: "6 eps",
  type: "Series",
  description: "Kehidupan para residen muda di rumah sakit penuh tantangan, dilema etika, dan ikatan persahabatan yang menguatkan.",
  trailer: "https://files.catbox.moe/dcrfaj.mp4",
  poster: "https://i.ibb.co.com/FLkSZqz4/images-2.jpg",
  Eps: [
    "https://cdn.turboviplay.com/data1/67fb1c027e264/67fb1c027e264.m3u8",
    "https://cdn.turboviplay.com/data1/67fc8bfa631f6/67fc8bfa631f6.m3u8",
    "https://cdn.turboviplay.com/data1/68048b38692d3/68048b38692d3.m3u8",
    "https://cdn.turboviplay.com/data1/6805a0f323dcb/6805a0f323dcb.m3u8",
    "https://cdn.turboviplay.com/data1/680d9a5692298/680d9a5692298.m3u8",
    "https://cdn.turboviplay.com/data1/680ee2768cd22/680ee2768cd22.m3u8"
  ]
},
  {
  title: "YAIBA: Samurai Legend",
  genre: "Action, Samurai, Fantasy",
  rating: "★ 8.7",
  year: "2025",
  duration: "4 eps",
  type: "Series anime",
  description: "Kisah epik samurai muda Yaiba yang berjuang menegakkan keadilan di dunia penuh kekacauan dan kekuatan jahat.",
  trailer: "https://files.catbox.moe/nvgbks.mp4",
  poster: "https://i.postimg.cc/x17QR25M/MV5-BNDc3-Ym-My-ZTkt-ZGQ4-Ni00-Yj-A2-LTk2-Yjgt-ZGFh-MDZj-Zjhl-Mz-Bl-Xk-Ey-Xk-Fqc-Gc-V1.jpg",
  Eps: [
    "https://storages.animein.net/Shin%20Samurai-den%20Yaiba%2F1-720p-1743847904940.mp4",
    "https://storages.animein.net/Shin%20Samurai-den%20Yaiba%2F2-720p-1744453022361.mp4",
    "https://storages.animein.net/Shin%20Samurai-den%20Yaiba%2F3-720p-1745057817698.mp4",
    "https://storages.animein.net/Shin%20Samurai-den%20Yaiba%2F4-720p-1745662342003.mp4"
  ]
},
  {
  "title": "Neighborhood Watch",
  "genre": "Thriller, Mystery",
  "rating": "★ 7.2",
  "year": "2025",
  "duration": "108min",
  "type": "Movie",
  "description": "Sebuah lingkungan pinggiran kota yang tampak tenang berubah menjadi medan penuh kecurigaan dan teror ketika serangkaian kejadian misterius mengungkap rahasia gelap para penghuninya.",
  "trailer": "https://files.catbox.moe/hfm1pi.mp4",
  "video": "https://cdn1.turboviplay.com/data1/680e4460e3ae6/680e4460e3ae6.m3u8",
  "poster": "https://s6.lk21static.buzz/wp-content/uploads/2025/04/film-neighborhood-watch-2025-lk21-d21.jpg.webp"
},
      {
  "title": "Armed",
  "genre": "Action, Horror, Thriller",
  "rating": "★ 6.2",
  "year": "2025",
  "duration": "94min",
  "type": "Movie",
  "description": "Sekelompok marinir veteran mencuri senjata militer, namun tanpa sengaja membangkitkan robot era Perang Dingin yang diprogram untuk memburu mereka tanpa ampun.",
  "trailer": "https://files.catbox.moe/abvaax.mp4",
  "video": "https://cdn1.turboviplay.com/data1/6810968e3b893/6810968e3b893.m3u8",
  "poster": "https://i.postimg.cc/MTgM1VBJ/p29406524-v-v13-aa.jpg"
},
    {
      "title": "Last Breath ",
      "genre": "Thriller, Mystery",
      "rating": "★ 6.8",
      "year": "2025",
      "duration": "115min",
      "type": "Movie",
      "description": "Seorang penyelam yang terjebak di dasar laut tanpa oksigen harus berjuang untuk bertahan hidup melawan waktu dan ketakutan terbesar dalam hidupnya.",
      "trailer": "https://files.catbox.moe/3laeli.mp4",
      "video": "https://cdn1.turboviplay.com/data1/6809d3b125bc5/6809d3b125bc5.m3u8",
      "poster": "https://i.postimg.cc/pTPkG1sJ/MV5-BYm-Nj-MDg1-Y2-Et-Nm-Zi-OS00-NGUz-LThj-ZGYt-Nz-U2-OGI5-M2-Vk-MDFh-Xk-Ey-Xk-Fqc-Gc-V1.jpg"
    },
    {
      "title": "Freaky Tales ",
      "genre": "Horror, Thriller",
      "rating": "★ 6.8",
      "year": "2025",
      "duration": "110min",
      "type": "Movie",
      "description": "Sekelompok teman menghadapi kejadian mengerikan ketika mereka menemukan buku kuno yang membawa mereka ke dalam dunia kegelapan yang tak terbayangkan.",
      "trailer": "https://files.catbox.moe/cb40vj.mp4",
      "video": "https://cdn1.turboviplay.com/data1/680daaf4d57d1/680daaf4d57d1.m3u8",
      "poster": "https://i.postimg.cc/BvbnTq0T/MV5-BMTUx-Nzk2-Nj-At-NGY2-My00-ZTVj-LTkx-YTQt-MWUz-ODUw-Nz-M3-NDhk-Xk-Ey-Xk-Fqc-Gc-V1.jpg"
    },
    {
      "title": "Havoc ",
      "genre": "Action, Thriller",
      "rating": "★ 7.5",
      "year": "2025",
      "duration": "135min",
      "type": "Movie",
      "description": "Seorang detektif yang sedang terjerat dalam dunia kriminal harus mengungkap rahasia besar sambil berjuang untuk menyelamatkan keluarganya.",
      "trailer": "https://files.catbox.moe/35wfot.mp4",
      "video": "https://cdn1.turboviplay.com/data1/680c38c55bebc/680c38c55bebc.m3u8",
      "poster": "https://i.postimg.cc/LXqhpmQ9/ems-c-HJk-LWVtcy1hc3-Nld-HMvb-W92a-WVz-Lz-Jl-NTkw-NTIx-LTM0-Ym-Yt-NDgz-Ni1h-ZGFl-LThj-ODM2-ZTA5-OTEz-Mi5qc-Gc-1.jpg"
    },
    {
      title: "Weak Hero Class 2 ",
      genre: "Action, Drama",
      rating: "★ 9.2",
      year: "2025",
      duration: "8 eps",
      type: "Series",
      description: "Yeon Si Eun kembali menghadapi tantangan baru di dunia sekolah keras yang brutal.",
      trailer: "https://files.catbox.moe/8g9571.mp4",
      poster: "https://i.postimg.cc/xCfzyRRj/images.jpg",
      Eps: [
        "https://cdn.turboviplay.com/data1/680b770dbbeef/680b770dbbeef.m3u8",
        "https://cdn.turboviplay.com/data1/680b7ce80bae4/680b7ce80bae4.m3u8",
        "https://cdn.turboviplay.com/data1/680b819204fa4/680b819204fa4.m3u8",
        "https://cdn.turboviplay.com/data1/680b864694917/680b864694917.m3u8",
        "https://cdn.turboviplay.com/data1/680b89c93ec8d/680b89c93ec8d.m3u8",
        "https://cdn.turboviplay.com/data1/680b8e78c1ea4/680b8e78c1ea4.m3u8",
        "https://cdn.turboviplay.com/data1/680b932732ad4/680b932732ad4.m3u8",
        "https://cdn.turboviplay.com/data1/680b9a58a7748/680b9a58a7748.m3u8"
      ]
    },
    {
  title: "Study Group",
  genre: "Action, School, Drama",
  rating: "★ 9.0",
  year: "2025",
  duration: "12 eps",
  type: "Series",
  description: "Gamin, siswa cerdas di sekolah brutal, membentuk kelompok belajar demi bertahan hidup dan mencapai impiannya.",
  trailer: "https://files.catbox.moe/ya3lh5.mp4",
  poster: "https://i.ibb.co.com/mC14pmyf/images-3.jpg",
  Eps: [
    "https://be6721.rcr72.waw04.cdn255.com/hls2/01/08114/c4fz4scj0zf7_x/master.m3u8?t=Bdmps_ihsNAmOrUD1ZTvj5Jj0AvylzEbrAaz19DBQs4&s=1745983478&e=10800&f=40574193&srv=36&asn=45146&sp=5500&p=",
    "https://be6721.rcr72.waw04.cdn255.com/hls2/01/08114/gweasg25sxdl_x/master.m3u8?t=BWAeofoBLfOuhLLbVXM5oPFCNd9oCqOnYAca2si_fBY&s=1745983578&e=10800&f=40574659&srv=50&asn=45146&sp=5500&p=",
    "https://cdn.turboviplay.com/data1/679c5b6210256/679c5b6210256.m3u8",
    "https://cdn.turboviplay.com/data1/679c600e8fa4e/679c600e8fa4e.m3u8",
    "https://cdn.turboviplay.com/data1/67a57ae8e861d/67a57ae8e861d.m3u8",
    "https://cdn.turboviplay.com/data1/67a57fa033a9f/67a57fa033a9f.m3u8",
    "https://cdn.turboviplay.com/data1/67af238a80499/67af238a80499.m3u8",
    "https://cdn.turboviplay.com/data1/67af29688ac48/67af29688ac48.m3u8",
    "https://cdn.turboviplay.com/data1/67b7eb3222145/67b7eb3222145.m3u8",
    "https://cdn.turboviplay.com/data1/67b7efe0a1b2b/67b7efe0a1b2b.m3u8"
  ]
},
    {
      title: "Locked ",
      genre: "Thriller",
      rating: "★ 8.9",
      year: "2025",
      duration: "120min",
      type: "Movie",
      description: "Seorang pencuri masuk ke SUV mewah dan menemukan dirinya dalam permainan psikologis horor.",
      trailer: "https://files.catbox.moe/xthmdm.mp4",
      video: "https://cdn1.turboviplay.com/data1/680943909ce01/680943909ce01.m3u8",
      poster: "https://i.postimg.cc/xjcgfhBZ/MV5-BZjg2-NDFh-ZDEt-Yz-Zl-ZC00-ZTRk-LTg4-NDct-Yj-Iw-NTQx-YWY4-ODFi-Xk-Ey-Xk-Fqc-Gc-V1.jpg"
    },
    {
      title: "A Working Man ",
      genre: "Drama",
      rating: "★ 7.8",
      year: "2025",
      duration: "110min",
      type: "Movie",
      description: "Seorang ayah bekerja keras menghadapi tantangan hidup demi keluarganya.",
      trailer: "https://files.catbox.moe/cqyhoh.mp4",
      video: "https://cdn1.turboviplay.com/data1/68094abf5703a/68094abf5703a.m3u8",
      poster: "https://i.postimg.cc/3JGBpp8C/MV5-BYm-Qx-ZGIx-NTYt-YTQw-My00-ODdk-LWI0-Mm-Qt-M2-E0-Zm-Iy-Nm-Yz-MGMz-Xk-Ey-Xk-Fqc-Gc-V1-FMjpg-UX1000.jpg"
    }
  ];
// ===== ELEMEN UI ===== //
const searchInput = document.getElementById("searchInput");
const genreSelect = document.getElementById("Genreselect");
const movieGrid = document.getElementById("movie-grid");
const modal = document.getElementById("video-modal");
const modalVideo = document.getElementById("modal-video");
const playButton = document.getElementById("play-btn");
const introVideo = document.getElementById("intro-video");
const overlay = document.getElementById("poster-overlay");
const genreEl = document.getElementById("genre");
const titleEl = document.getElementById("film-title");
const metaEl = document.getElementById("meta-info");
const descEl = document.getElementById("film-desc");
const EpButtons = document.getElementById("Ep-buttons");

let currentFilm = movies[0];
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

// ===== FUNGSI UTAMA ===== //
function renderMovies(moviesToShow) {
  movieGrid.innerHTML = '';
  
  if (moviesToShow.length > 0) {
    moviesToShow.forEach(movie => {
      const div = document.createElement("div");
      div.innerHTML = `
        <img src="${movie.poster}" alt="${movie.title}">
        <div class="grid-title">${movie.title}</div>
      `;
      div.onclick = () => loadFilm(movie);
      movieGrid.appendChild(div);
    });
  } else {
    movieGrid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #ccc;">Tidak ada film yang sesuai</p>';
  }
}

function loadFilm(film) {
  // Hentikan semua video
  introVideo.pause();
  introVideo.currentTime = 0;
  modalVideo.pause();
  modalVideo.currentTime = 0;

  // Set poster dan trailer
  overlay.style.backgroundImage = `url('${film.poster}')`;
  overlay.style.opacity = 1;
  
  introVideo.src = film.trailer;
  introVideo.load();

  introVideo.oncanplay = () => {
    overlay.style.opacity = 0;
    introVideo.play()
      .then(() => introVideo.muted = false)
      .catch(e => {
        console.log("Autoplay diblokir, menggunakan muted");
        introVideo.muted = true;
        introVideo.play();
      });
  };

  // Update info film
  genreEl.textContent = film.genre;
  titleEl.textContent = film.title;
  metaEl.textContent = `${film.rating} · ${film.year} · ${film.duration} · ${film.type}`;
  descEl.textContent = film.description;
  
  // Handle episode buttons
  EpButtons.innerHTML = '';
  if (film.Eps) {
    film.Eps.forEach((ep, i) => {
      const btn = document.createElement('button');
      btn.textContent = `Ep ${i+1}`;
      btn.onclick = () => playVideo(ep);
      EpButtons.appendChild(btn);
    });
  }
  currentFilm = film;
}

function applyFilters() {
  const searchTerm = searchInput.value.trim();
  const genre = genreSelect.value;
  
  let filteredMovies = [...movies];
  
  if (searchTerm) {
    filteredMovies = filteredMovies.filter(movie => 
      movie.title.toLowerCase().includes(searchTerm.toLowerCase())
    );
  }
  
  if (genre) {
    filteredMovies = filteredMovies.filter(movie => 
      movie.genre.toLowerCase().includes(genre.toLowerCase())
    );
  }
  
  renderMovies(filteredMovies);
}

function requestFullscreen(el) {
  if (el.requestFullscreen) {
    el.requestFullscreen();
  } else if (el.webkitRequestFullscreen) {
    el.webkitRequestFullscreen();
  } else if (el.msRequestFullscreen) {
    el.msRequestFullscreen();
  }
}

function closeModal() {
  modal.style.display = "none";
  modalVideo.pause();
  modalVideo.currentTime = 0;
  
  // Exit fullscreen safely
  if (document.fullscreenElement) {
    document.exitFullscreen().catch(e => console.log("Fullscreen exit error:", e));
  }
  
  // Push new state to prevent back navigation
  history.pushState({ modalClosed: true }, "");
}

function openVideoModal() {
  // Stop intro video completely
  introVideo.pause();
  introVideo.currentTime = 0;
  introVideo.removeAttribute('src');
  
  // Show modal
  modal.style.display = "flex";
  
  // Handle mobile differently
  if (isMobile) {
    modalVideo.setAttribute('controls', ''); // Aktifkan kontrol native
    modalVideo.setAttribute('playsinline', '');
    modalVideo.setAttribute('webkit-playsinline', '');
    modalVideo.play().catch(e => {
      console.log("Mobile play error:", e);
      modalVideo.muted = true;
      modalVideo.play();
    });
  } else {
    // Desktop behavior
    modalVideo.requestFullscreen().then(() => {
      modalVideo.play();
    }).catch(e => {
      console.log("Fullscreen error:", e);
      modalVideo.play();
    });
  }
  
  // Add history state
  history.pushState({ modalOpen: true }, "");
}

// ===== EVENT HANDLERS ===== 
function setupEventListeners() {
  // Search and filter
  searchInput.addEventListener("input", () => applyFilters());
  genreSelect.addEventListener("change", () => applyFilters());
  
  // Play button
  playButton.onclick = () => {
    const videoSource = currentFilm.video || (currentFilm.Eps && currentFilm.Eps[0]);
    if (videoSource) playVideo(videoSource);
    else alert("Video tidak tersedia");
  };
  
  // Modal close
  const closeBtn = document.getElementById('close-modal');
  closeBtn.addEventListener('click', closeModal);
  closeBtn.addEventListener('touchend', (e) => {
    e.preventDefault();
    closeModal();
  });
  
  // Handle back button
  window.addEventListener('popstate', (e) => {
    if (modal.style.display === "flex") {
      e.preventDefault();
      closeModal();
      // Add new state to prevent exiting
      setTimeout(() => history.pushState({ modalPreventExit: true }, ""), 10);
    }
  });
  
  // Prevent exit during playback
  window.addEventListener('beforeunload', (e) => {
    if (modal.style.display === "flex") {
      e.preventDefault();
      return "Anda sedang menonton video. Yakin ingin keluar?";
    }
  });
}

searchInput.addEventListener("input", () => applyFilters());
genreSelect.addEventListener("change", () => applyFilters());

// 🔥 Kode baru untuk tombol play di sini! 🔥
playButton.onclick = () => {
  introVideo.pause();
  introVideo.currentTime = 0;

  const videoSource = currentFilm.video || (currentFilm.Eps && currentFilm.Eps[0]);
  
  if (!videoSource) {
    alert("Video tidak tersedia");
    return;
  }

  if (videoSource.endsWith('.mp4')) {
    modalVideo.src = videoSource;
    modalVideo.type = 'video/mp4';
    openVideoModal();
  }
  else if (videoSource.endsWith('.m3u8')) {
    if (Hls.isSupported()) {
      const hls = new Hls();
      hls.loadSource(videoSource);
      hls.attachMedia(modalVideo);
      hls.on(Hls.Events.MANIFEST_PARSED, openVideoModal);
    } else if (modalVideo.canPlayType('application/vnd.apple.mpegurl')) {
      modalVideo.src = videoSource;
      openVideoModal();
    } else {
      alert("Browser tidak mendukung format HLS (.m3u8)");
    }
  }
  else {
    alert("Format video tidak valid");
  }
};

// Tutup modal
document.getElementById('close-modal').addEventListener('click', closeModal);
document.getElementById('close-modal').addEventListener('touchend', closeModal);

window.addEventListener('beforeunload', (e) => {
  if (modal.style.display === "flex") {
    e.preventDefault();
    return "Anda sedang menonton video. Yakin ingin keluar?";
  }
});
// Handle back button mobile
window.addEventListener('popstate', (e) => {
  if (modal.style.display === "flex") {
    e.preventDefault();
    closeModal();
  }
});

// Fungsi splash screen tanpa skip
function initSplashScreen() {
  const splashScreen = document.getElementById('splash-screen');
  
  // Tampilkan splash screen selama 3 detik
  setTimeout(() => {
    splashScreen.classList.add('fade-out');
    
    // Hapus element setelah animasi selesai
    setTimeout(() => {
      splashScreen.remove();
    }, 500); // Durasi animasi fade out
  }, 3000); // 3000ms = 3 detik
}

// Panggil saat halaman load
window.addEventListener('DOMContentLoaded', () => {
  renderMovies(movies);
  loadFilm(currentFilm);
  setupEventListeners();
  initSplashScreen();
});
// yang bikin mp4 berjalan
function playVideo(source) {
  // Hentikan intro video sepenuhnya
  introVideo.pause();
  introVideo.currentTime = 0;
  introVideo.src = "";
  
  // Reset modal video
  modalVideo.pause();
  modalVideo.currentTime = 0;
  modalVideo.src = "";

  if (source.endsWith('.mp4')) {
    modalVideo.src = source;
    modalVideo.type = 'video/mp4';
  } else {
    if (Hls.isSupported()) {
      const hls = new Hls();
      hls.loadSource(source);
      hls.attachMedia(modalVideo);
    } else if (modalVideo.canPlayType('application/vnd.apple.mpegurl')) {
      modalVideo.src = source;
    }
  }

  modal.style.display = "flex";
  modalVideo.play()
    .catch(e => {
      console.log("Autoplay diblokir, menggunakan muted");
      modalVideo.muted = true;
      modalVideo.play();
    });
}